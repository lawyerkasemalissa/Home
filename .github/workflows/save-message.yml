name: Save Message

on:
  repository_dispatch:
    types: [new-message]

jobs:
  save:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{secrets.MY_SECRET_TOKEN}}  # â† Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­ÙÙˆØ¸ ÙÙŠ GitHub Secrets

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Prepare message
        run: |
          mkdir -p data
          touch data/messages.json
          echo "ğŸ”„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:"
          echo '${{ github.event.client_payload.message }}'

          node <<EOF
          const fs = require('fs');
          const path = 'data/messages.json';
          const newMessage = {
            name: '${{ github.event.client_payload.name }}',
            email: '${{ github.event.client_payload.email }}',
            message: '${{ github.event.client_payload.message }}',
            date: new Date().toISOString()
          };

          let messages = [];
          if (fs.existsSync(path)) {
            messages = JSON.parse(fs.readFileSync(path, 'utf8'));
          }
          messages.push(newMessage);
          fs.writeFileSync(path, JSON.stringify(messages, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add data/messages.json
          git commit -m "ğŸ“© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${{ github.event.client_payload.name }}"
          git push https://x-access-token:${GH_TOKEN}@github.com/lawyerkasemalissa/Home.git